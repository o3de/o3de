name: o3de
version: '${CPACK_PACKAGE_VERSION}'
summary: O3DE Engine
description: |
  Open 3D Engine (O3DE) is an Apache 2.0-licensed multi-platform 3D engine that enables developers and content creators to build AAA games, cinema-quality 3D worlds, and high-fidelity simulations without any fees or commercial obligations. 
license: Apache-2.0
confinement: classic
base: core22

parts:
  o3de:
    plugin: dump
    source: ./${CPACK_PACKAGE_NAME}
    source-type: local
    build-attributes:
     - enable-patchelf
    stage-packages:
     - cmake
     - clang-14
     - ninja-build
     - libglu1-mesa-dev
     - libxcb-xinerama0
     - libxcb-xinput0
     - libxcb-xinput-dev
     - libxcb-xfixes0-dev
     - libxcb-xkb-dev
     - libxkbcommon-dev
     - libxkbcommon-x11-dev
     - libfontconfig1-dev
     - libcurl4-openssl-dev
     - libsdl2-dev
     - zlib1g-dev
     - mesa-common-dev
     - libssl-dev
     - libffi8
     - libxcb-icccm4
     - libxcb-image0
     - libxcb-keysyms1
     - libxcb-randr0
     - libxcb-render-util0
     - libunwind-dev
     - pkg-config
     - libstdc++-12-dev
     
     #- libhogweed6
     #- libssl3
     #- libffi7
     #- libnettle8

  patch-o3de:
    plugin: nil
    after: [o3de]
    build-packages: [patchelf]
    override-stage: |
      snapcraftctl stage
      find $SNAPCRAFT_STAGE/usr/bin/ -type f -executable -exec patchelf --set-interpreter /snap/core22/current/lib64/ld-linux-x86-64.so.2 {} \;
      find $SNAPCRAFT_STAGE/usr/lib/ -type f -executable -exec patchelf --set-interpreter /snap/core22/current/lib64/ld-linux-x86-64.so.2 {} \;
      find $SNAPCRAFT_STAGE/usr/bin/ -type f -executable -exec patchelf --force-rpath --set-rpath $(patchelf --print-rpath {})':/snap/core22/current/lib/x86_64-linux-gnu:/snap/core22/current/usr/lib/x86_64-linux-gnu' {} \;
      find $SNAPCRAFT_STAGE/usr/lib/ -type f -exec patchelf --force-rpath --set-rpath $(patchelf --print-rpath {})':/snap/core22/current/lib/x86_64-linux-gnu:/snap/core22/current/usr/lib/x86_64-linux-gnu' {} \;
      find $SNAPCRAFT_STAGE/lib/ -type f -exec patchelf --force-rpath --set-rpath $(patchelf --print-rpath {} )':/snap/core22/current/lib/x86_64-linux-gnu:/snap/core22/current/usr/lib/x86_64-linux-gnu' {} \;
      find $SNAPCRAFT_STAGE/lib32/ -type f -exec patchelf --force-rpath --set-rpath $(patchelf --print-rpath {} )':/snap/core22/current/lib/x86_64-linux-gnu:/snap/core22/current/usr/lib/x86_64-linux-gnu' {} \;

apps:
  o3de:
    command: ${CPACK_PACKAGE_VERSION}/bin/Linux/profile/Default/o3de
    environment:
      LD_LIBRARY_PATH: $SNAP/${CPACK_PACKAGE_VERSION}/bin/Linux/profile/Default:$LD_LIBRARY_PATH
      SNAP_BUILD: ${CPACK_PACKAGE_VERSION}
      DISABLE_WAYLAND: 1
  editor:
    command: ${CPACK_PACKAGE_VERSION}/bin/Linux/profile/Default/Editor
    environment:
      LD_LIBRARY_PATH: $SNAP/${CPACK_PACKAGE_VERSION}/bin/Linux/profile/Default:$LD_LIBRARY_PATH
      DISABLE_WAYLAND: 1
  assetprocessor:
    command: ${CPACK_PACKAGE_VERSION}/bin/Linux/profile/Default/AssetProcessor
    environment:
      LD_LIBRARY_PATH: $SNAP/${CPACK_PACKAGE_VERSION}/bin/Linux/profile/Default:$LD_LIBRARY_PATH
      DISABLE_WAYLAND: 1
    
