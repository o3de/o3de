/*
* Modifications Copyright (c) Contributors to the Open 3D Engine Project.
* For complete copyright and license terms please see the LICENSE at the root of this distribution.
*
* SPDX-License-Identifier: (Apache-2.0 OR MIT) AND MIT
*
*/

#include <Atom/Features/SrgSemantics.azsli>
#include <HairUtilities.azsli> 

//!------------------------------ SRG Structure --------------------------------
//! Per pass SRG that holds the dynamic shared read-write buffer shared 
//! across all dispatches and draw calls. It is used for all the dynamic buffers
//! that can change between passes due to the application of skinning, simulation 
//! and physics affect. 
//! Once the compute pases are done, it is read by the rendering shaders.  
ShaderResourceGroup PassSrg : SRG_PerPass_WithFallback
{
    // Linear depth is used for getting the screen to world transform
    Texture2D<float>    m_linearDepth;

    // oiriginally: [[vk::binding(0, 0)]] Texture2D<float4> HaiColorTexture : register(t0, space0);
    // oiriginally: [[vk::binding(1, 0)]] Texture2D<float>  AccumInvAlpha : register(t1, space0);
    Texture2D<float4>   m_hairColorTexture;
    Texture2D<float>    m_accumInvAlpha;
}
//------------------------------------------------------------------------------

#include <HairFullScreenUtils.azsli>    // provides the Vertex Shader

//!=============================================================================
//!                 HairColorPS - Fourth Pass of ShortCut Render
//! Full-screen pass that finalizes the weighted average, and blends using the 
//! accumulated 1-alpha product.
//!=============================================================================
[earlydepthstencil]
float4 HairShortCutResolveColorPS(VSOutput input) : SV_Target
{
    int2 vScreenAddress = int2(input.m_position.xy);

    float fInvAlpha = PassSrg::m_accumInvAlpha[vScreenAddress];
    float fAlpha = 1.0 - fInvAlpha;

    if (fAlpha < SHORTCUT_MIN_ALPHA)
        return float4(0, 0, 0, 1);

    float4 finalColor;
    float weightSum = PassSrg::m_hairColorTexture[vScreenAddress].w;

    finalColor.xyz = PassSrg::m_hairColorTexture[vScreenAddress] * fAlpha / weightSum;
    finalColor.w = fInvAlpha;

    return finalColor;
}
