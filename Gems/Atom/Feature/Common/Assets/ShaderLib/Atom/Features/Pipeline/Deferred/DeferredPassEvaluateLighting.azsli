/*
 * Copyright (c) Contributors to the Open 3D Engine Project.
 * For complete copyright and license terms please see the LICENSE at the root of this distribution.
 *
 * SPDX-License-Identifier: Apache-2.0 OR MIT
 *
 */

#pragma once

#ifndef EvaluateLighting
#define EvaluateLighting EvaluateLighting_DeferredPass
#endif

#include <Atom/Features/Debug.azsli>

#include <Atom/Features/Pipeline/Forward/ForwardPassEvaluateLighting.azsli>
#include <Atom/Features/Pipeline/Deferred/DeferredPassIbl.azsli>

LightingData EvaluateLighting_DeferredPass(Surface surface, float4 screenPosition, float3 viewPosition)
{
    LightingData lightingData;
    InitializeLightingData(surface, viewPosition, lightingData);

    // Light iterator
    LightCullingTileIterator tileIterator;
#if ENABLE_LIGHT_CULLING
    tileIterator.Init(screenPosition, PassSrg::m_lightListRemapped, PassSrg::m_tileLightData);
#else
    tileIterator.InitNoCulling();
#endif

    // Apply Decals (same as the ForwardPass)
    ApplyDecals_ForwardPass(tileIterator, surface);

    // Apply Direct Lighting (same as the ForwardPass)
    ApplyDirectLighting_ForwardPass(surface, lightingData, screenPosition, tileIterator);

    // Apply Image Based Lighting (IBL) for deferred
    ApplyIbl_DeferredPass(surface, lightingData);

    FinalizeLightingData(surface, lightingData);
    return lightingData;
}

